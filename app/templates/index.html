{% extends 'base.html' %}
{% block content %}
<section class="card">
    <h2>Start a Scrape</h2>
    <form method="post" action="{{ url_for('start_scrape') }}" class="form-grid">
        <label>
            Base URL
            <input type="url" name="base_url" value="{{ default_base_url }}" required>
        </label>
        <label>
            Page Wait (seconds)
            <input type="number" name="page_wait" min="1" value="{{ default_wait }}" required>
        </label>
        <label>
            Scrape Mode
            <select name="scrape_mode">
                <option value="new" {% if default_mode == 'new' %}selected{% endif %}>Scrape new only</option>
                <option value="full" {% if default_mode == 'full' %}selected{% endif %}>Scrape from scratch</option>
            </select>
        </label>
        <label>
            New Rows Limit
            <input type="number" name="new_limit" min="0" value="{{ default_new_limit }}" required>
        </label>
        <label>
            Delay Between Downloads (seconds)
            <input type="number" step="0.1" name="per_download_delay" min="0" value="{{ default_delay }}" required>
        </label>
        <fieldset class="form-fieldset">
            <legend>Reset Before Run</legend>
            <label class="checkbox">
                <input type="checkbox" name="reset_before_run" value="1" {% if default_reset_before_run %}checked{% endif %}>
                Reset metadata before starting (forces Full mode)
            </label>
            <label class="checkbox reset-delete-option" data-reset-dependent>
                <input type="checkbox" name="reset_delete_pdfs" value="1" {% if default_reset_delete_pdfs %}checked{% endif %}>
                Also delete downloaded PDFs (confirmation required)
            </label>
        </fieldset>
        <div class="form-actions">
            <button type="submit" class="primary">Start Scrape</button>
            <a href="{{ url_for('report') }}" class="button">View Report</a>
            <a href="{{ url_for('download_all_zip') }}" class="button">Download All as ZIP</a>
        </div>
    </form>
</section>

{% if last_summary %}
<section class="card">
    <h2>Last Run Summary</h2>
    <ul class="summary-list">
        <li><strong>Processed:</strong> {{ last_summary.processed }}</li>
        <li><strong>Downloaded:</strong> {{ last_summary.downloaded }}</li>
        <li><strong>Skipped:</strong> {{ last_summary.skipped }}</li>
        <li><strong>Failed:</strong> {{ last_summary.failed }}</li>
        <li><strong>Rows Inspected:</strong> {{ last_summary.inspected_rows | default(last_summary.processed) }}</li>
        <li><strong>Mode:</strong> {{ last_summary.scrape_mode | default('new') }}</li>
    </ul>
    <a href="{{ url_for('report') }}" class="button">View Detailed Report</a>
</section>
{% endif %}
<script>
const modeSelect = document.querySelector('select[name="scrape_mode"]');
const limitInput = document.querySelector('input[name="new_limit"]');
const resetCheckbox = document.querySelector('input[name="reset_before_run"]');
const deletePdfsCheckbox = document.querySelector('input[name="reset_delete_pdfs"]');
function toggleLimit() {
    if (!modeSelect || !limitInput) {
        return;
    }
    const isNew = modeSelect.value === 'new';
    limitInput.disabled = !isNew;
    if (!isNew) {
        limitInput.setAttribute('aria-disabled', 'true');
    } else {
        limitInput.removeAttribute('aria-disabled');
    }
}
if (modeSelect && limitInput) {
    modeSelect.addEventListener('change', toggleLimit);
    toggleLimit();
}
if (resetCheckbox && deletePdfsCheckbox) {
    const syncResetState = () => {
        if (!resetCheckbox.checked) {
            deletePdfsCheckbox.checked = false;
            deletePdfsCheckbox.disabled = true;
            deletePdfsCheckbox.closest('label').classList.add('disabled');
        } else {
            deletePdfsCheckbox.disabled = false;
            deletePdfsCheckbox.closest('label').classList.remove('disabled');
        }
    };
    deletePdfsCheckbox.addEventListener('change', (event) => {
        if (event.target.checked) {
            const confirmed = window.confirm('Delete all downloaded PDFs before running? This cannot be undone.');
            if (!confirmed) {
                event.target.checked = false;
            }
        }
    });
    resetCheckbox.addEventListener('change', syncResetState);
    syncResetState();
}
</script>
{% endblock %}
