{% extends 'base.html' %}
{% block content %}
<section class="card">
    <h2>Scrape Report</h2>
    <p><strong>Target URL:</strong> <a href="{{ base_url }}" target="_blank" rel="noopener">{{ base_url }}</a></p>
    <p><strong>CSV Source:</strong> <a href="{{ csv_url }}" target="_blank" rel="noopener">judgments.csv</a></p>
    <p><strong>Downloaded Cases:</strong> {{ downloads|length }}</p>
    <div class="button-row">
        <a href="{{ url_for('index') }}" class="button">Home</a>
        <a href="{{ url_for('download_all_zip') }}" class="button">Download All ZIP</a>
        <a href="{{ url_for('export_csv') }}" class="button">Export Metadata CSV</a>
        <a href="{{ url_for('start_scrape') }}" class="button" onclick="event.preventDefault(); document.getElementById('run-again-form').submit();">Run Again</a>
        <a href="{{ url_for('api_export_latest_xlsx') }}" class="button">Export latest run (Excel)</a>
    </div>
    {% if last_summary and last_summary.run_health %}
    <div class="summary-badges">
        <span class="badge">Run health: {{ last_summary.run_health|upper }}</span>
        <span class="badge">Coverage: {{ last_summary.cases_downloaded | default(0) }} / {{ last_summary.cases_planned | default(0) }}</span>
        {% if last_summary.cases_failed %}
        <span class="badge warning">Failed: {{ last_summary.cases_failed }}</span>
        {% endif %}
    </div>
    {% endif %}
    {% if last_summary %}
    <ul class="summary-list">
        <li><strong>Total CSV Entries:</strong> {{ last_summary.total_cases }}</li>
        <li><strong>Processed:</strong> {{ last_summary.processed }}</li>
        <li><strong>Downloaded:</strong> {{ last_summary.downloaded }}</li>
        <li><strong>Skipped:</strong> {{ last_summary.skipped }}</li>
        <li><strong>Failed:</strong> {{ last_summary.failed }}</li>
        <li><strong>Rows Inspected:</strong> {{ last_summary.inspected_rows | default(last_summary.processed) }}</li>
        <li><strong>Mode:</strong> {{ last_summary.scrape_mode | default('new') }}</li>
    </ul>
    {% endif %}
    <p><strong>Current Log File:</strong> <a href="{{ url_for('download_log', filename=current_log_name) }}">{{ current_log_name }}</a></p>
    <form id="run-again-form" method="post" action="{{ url_for('start_scrape') }}" hidden>
        <input type="hidden" name="base_url" value="{{ last_params.base_url | default(base_url) }}">
        <input type="hidden" name="page_wait" value="{{ last_params.page_wait | default(config.PAGE_WAIT_SECONDS) }}">
        <input type="hidden" name="scrape_mode" value="{{ last_params.scrape_mode | default(config.SCRAPE_MODE_DEFAULT) }}">
        <input type="hidden" name="new_limit" value="{{ last_params.new_limit | default(config.SCRAPE_NEW_LIMIT) }}">
        <input type="hidden" name="max_retries" value="{{ last_params.max_retries | default(config.SCRAPER_MAX_RETRIES) }}">
        <input type="hidden" name="per_download_delay" value="{{ last_params.per_download_delay | default(config.PER_DOWNLOAD_DELAY) }}">
        <input type="hidden" name="target_source" value="{{ last_params.target_source | default(config.DEFAULT_SOURCE) }}">
    </form>
</section>

<section class="card">
    <h3>Run History</h3>
    <div class="table-actions">
        <label for="runs-source-filter">
            Source
            <select id="runs-source-filter">
                <option value="">All</option>
                {% for source in available_sources %}
                <option value="{{ source }}">{{ source }}</option>
                {% endfor %}
            </select>
        </label>
    </div>
    <div class="table-scroll">
        <table id="run-history" class="display compact" style="width:100%">
            <thead>
                <tr>
                    <th>Run ID</th>
                    <th>Source</th>
                    <th>Trigger</th>
                    <th>Mode</th>
                    <th>Status</th>
                    <th>Started At</th>
                    <th>Ended At</th>
                    <th>CSV Version</th>
                    <th>Downloaded</th>
                    <th>Failed</th>
                    <th>Skipped</th>
                    <th>Health</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>

<section class="card">
    <h3>Downloaded Cases</h3>
    {% if last_summary %}
    <div class="summary-badges">
        <span class="badge">Downloaded: {{ last_summary.downloaded | default(0) }}</span>
        <span class="badge">Skipped: {{ last_summary.skipped | default(0) }}</span>
        <span class="badge">Failed: {{ last_summary.failed | default(0) }}</span>
        {% if last_summary.stop_reason %}
        <span class="badge warning">Stop Reason: {{ last_summary.stop_reason }}</span>
        {% endif %}
    </div>
    {% if last_summary.skip_reasons %}
    <details class="reason-panel" open>
        <summary>Skip reasons</summary>
        <ul>
        {% for reason, count in last_summary.skip_reasons.items() %}
            <li><strong>{{ reason }}</strong>: {{ count }}</li>
        {% endfor %}
        </ul>
    </details>
    {% endif %}
    {% if last_summary.fail_reasons %}
    <details class="reason-panel" open>
        <summary>Failure reasons</summary>
        <ul>
        {% for reason, count in last_summary.fail_reasons.items() %}
            <li><strong>{{ reason }}</strong>: {{ count }}</li>
        {% endfor %}
        </ul>
    </details>
    {% endif %}
    {% endif %}
    <div class="table-actions">
        <label for="downloaded-cases-source-filter">
            Source
            <select id="downloaded-cases-source-filter">
                <option value="">All</option>
                {% for source in available_sources %}
                <option value="{{ source }}">{{ source }}</option>
                {% endfor %}
            </select>
        </label>
    </div>
    <div class="table-scroll">
        <table id="downloaded-cases" class="display compact" style="width:100%">
            <thead>
                <tr>
                    <th>Judgment Date</th>
                    <th>Title</th>
                    <th>Subject</th>
                    <th>Court</th>
                    <th>Category</th>
                    <th>Source</th>
                    <th>Cause Number</th>
                    <th>Saved File</th>
                    <th>Size (KB)</th>
                    <th>Actions Token</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <form method="post" action="{{ url_for('reset_view') }}" class="reset-form">
        <label><input type="checkbox" name="delete_pdfs" value="1"> Delete PDFs</label>
        <label><input type="checkbox" name="delete_logs" value="1"> Delete logs</label>
        <button type="submit" class="button danger">Reset State</button>
    </form>
</section>

<section class="card">
    <h3>Live Logs</h3>
    <pre id="log-output" class="log-area">{% for line in log_lines %}{{ line }}
{% endfor %}</pre>
</section>

<script>
const logOutput = document.getElementById('log-output');
if (window.EventSource) {
    const source = new EventSource('{{ url_for('logs_stream') }}');
    source.onmessage = function(event) {
        logOutput.textContent += event.data + "\n";
        logOutput.scrollTop = logOutput.scrollHeight;
    };
}

$(function() {
    const runsTableEl = $('#run-history');
    const runsSourceFilter = $('#runs-source-filter');
    if (runsTableEl.length) {
        const runsApiBase = '{{ url_for('api_db_runs_list') }}';
        const runsUrl = () => {
            const source = runsSourceFilter.val();
            if (source) {
                return `${runsApiBase}?source=${encodeURIComponent(source)}`;
            }
            return runsApiBase;
        };

        const runsTable = runsTableEl.DataTable({
            ajax: {
                url: runsUrl(),
                dataSrc: function(json) { return (json && json.runs) || []; }
            },
            deferRender: true,
            scrollY: '40vh',
            scroller: true,
            order: [[5, 'desc']],
            columns: [
                { data: 'id', title: 'Run ID' },
                { data: 'target_source', title: 'Source' },
                { data: 'trigger', title: 'Trigger' },
                { data: 'mode', title: 'Mode' },
                { data: 'status', title: 'Status' },
                { data: 'started_at', title: 'Started At' },
                { data: 'ended_at', title: 'Ended At' },
                { data: 'csv_version_id', title: 'CSV Version' },
                { data: 'cases_downloaded', title: 'Downloaded' },
                { data: 'cases_failed', title: 'Failed' },
                { data: 'cases_skipped', title: 'Skipped' },
                { data: 'run_health', title: 'Health' }
            ]
        });

        runsSourceFilter.on('change', function() {
            runsTable.ajax.url(runsUrl()).load();
        });
    }

    const downloadsTableEl = $('#downloaded-cases');
    const downloadsSourceFilter = $('#downloaded-cases-source-filter');
    if (downloadsTableEl.length) {
        const downloadsApiBase = '{{ url_for('api_downloaded_cases') }}';
        const downloadsUrl = () => {
            const source = downloadsSourceFilter.val();
            if (source) {
                return `${downloadsApiBase}?source=${encodeURIComponent(source)}`;
            }
            return downloadsApiBase;
        };

        const downloadsTable = downloadsTableEl.DataTable({
            ajax: downloadsUrl(),
            deferRender: true,
            scrollY: '50vh',
            scroller: true,
            order: [[0, 'desc']],
            columns: [
                { data: 'judgment_date', title: 'Judgment Date' },
                { data: 'title', title: 'Title', render: function(data, type, row) {
                    if (type === 'display') {
                        const href = row.saved_path ? `{{ url_for('download_file', filename='') }}/${row.saved_path}` : '#';
                        return `<a href="${href}">${data || 'â€”'}</a>`;
                    }
                    return data || '';
                }},
                { data: 'subject', title: 'Subject' },
                { data: 'court', title: 'Court' },
                { data: 'category', title: 'Category' },
                { data: 'source', title: 'Source' },
                { data: 'cause_number', title: 'Cause Number' },
                { data: 'filename', title: 'Saved File' },
                { data: 'size_kb', title: 'Size (KB)' },
                { data: 'actions_token', title: 'Actions Token' }
            ]
        });

        downloadsSourceFilter.on('change', function() {
            downloadsTable.ajax.url(downloadsUrl()).load();
        });
    }
});
</script>
{% endblock %}
