{% extends 'base.html' %}
{% block content %}
<section class="card">
    <h2>Scrape Report</h2>
    <p><strong>Target URL:</strong> <a href="{{ base_url }}" target="_blank" rel="noopener">{{ base_url }}</a></p>
    <p><strong>CSV Source:</strong> <a href="{{ csv_url }}" target="_blank" rel="noopener">judgments.csv</a></p>
    <p><strong>Downloaded Cases:</strong> {{ downloads|length }}</p>
    <div class="button-row">
        <a href="{{ url_for('index') }}" class="button">Home</a>
        <a href="{{ url_for('download_all_zip') }}" class="button">Download All ZIP</a>
        <a href="{{ url_for('export_csv') }}" class="button">Export Metadata CSV</a>
        <a href="{{ url_for('start_scrape') }}" class="button" onclick="event.preventDefault(); document.getElementById('run-again-form').submit();">Run Again</a>
    </div>
    {% if last_summary %}
    <ul class="summary-list">
        <li><strong>Total CSV Entries:</strong> {{ last_summary.total_cases }}</li>
        <li><strong>Processed:</strong> {{ last_summary.processed }}</li>
        <li><strong>Downloaded:</strong> {{ last_summary.downloaded }}</li>
        <li><strong>Skipped:</strong> {{ last_summary.skipped }}</li>
        <li><strong>Failed:</strong> {{ last_summary.failed }}</li>
        <li><strong>Rows Inspected:</strong> {{ last_summary.inspected_rows | default(last_summary.processed) }}</li>
        <li><strong>Mode:</strong> {{ last_summary.scrape_mode | default('new') }}</li>
    </ul>
    {% endif %}
    <p><strong>Current Log File:</strong> <a href="{{ url_for('download_log', filename=current_log_name) }}">{{ current_log_name }}</a></p>
    <form id="run-again-form" method="post" action="{{ url_for('start_scrape') }}" hidden>
        <input type="hidden" name="base_url" value="{{ last_params.base_url | default(base_url) }}">
        <input type="hidden" name="page_wait" value="{{ last_params.page_wait | default(config.PAGE_WAIT_SECONDS) }}">
        <input type="hidden" name="scrape_mode" value="{{ last_params.scrape_mode | default(config.SCRAPE_MODE_DEFAULT) }}">
        <input type="hidden" name="new_limit" value="{{ last_params.new_limit | default(config.SCRAPE_NEW_LIMIT) }}">
        <input type="hidden" name="max_retries" value="{{ last_params.max_retries | default(config.SCRAPER_MAX_RETRIES) }}">
        <input type="hidden" name="per_download_delay" value="{{ last_params.per_download_delay | default(config.PER_DOWNLOAD_DELAY) }}">
    </form>
</section>

<section class="card">
    <h3>Downloaded Cases</h3>
    {% if downloads %}
    <div class="table-controls">
        <label>
            Court
            <select id="filter-court">
                <option value="">All Courts</option>
                {% for court in courts %}
                <option value="{{ court }}">{{ court }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Category
            <select id="filter-category">
                <option value="">All Categories</option>
                {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
        </label>
        <label class="grow">
            Search
            <input type="search" id="filter-search" placeholder="Subject or Cause Number">
        </label>
        <form method="post" action="{{ url_for('reset_view') }}" class="reset-form">
            <label><input type="checkbox" name="delete_pdfs" value="1"> Delete PDFs</label>
            <label><input type="checkbox" name="delete_logs" value="1"> Delete logs</label>
            <button type="submit" class="button danger">Reset State</button>
        </form>
    </div>
    <div class="table-scroll">
        <table id="downloads-table">
            <thead>
                <tr>
                    <th data-sort-key="judgment-date">Judgment Date</th>
                    <th data-sort-key="cause-number">Cause Number</th>
                    <th data-sort-key="subject">Subject</th>
                    <th data-sort-key="court">Court</th>
                    <th data-sort-key="category">Category</th>
                    <th data-sort-key="filename">PDF</th>
                    <th data-sort-key="downloaded-at">Downloaded At</th>
                </tr>
            </thead>
            <tbody>
                {% for row in downloads %}
                <tr data-court="{{ row.court }}" data-category="{{ row.category }}" data-search="{{ (row.subject ~ ' ' ~ row.cause_number ~ ' ' ~ row.title)|lower }}">
                    <td data-column="judgment-date" data-sort="{{ row.sort_judgment_date }}">{{ row.judgment_date or '—' }}</td>
                    <td data-column="cause-number" data-sort="{{ row.cause_number|lower }}">{{ row.cause_number or '—' }}</td>
                    <td data-column="subject" data-sort="{{ row.subject|lower }}">{{ row.subject or row.title }}</td>
                    <td data-column="court" data-sort="{{ row.court|lower }}">{{ row.court or '—' }}</td>
                    <td data-column="category" data-sort="{{ row.category|lower }}">{{ row.category or '—' }}</td>
                    <td data-column="filename" data-sort="{{ row.local_filename|lower }}" class="mono"><a href="{{ url_for('download_file', filename=row.local_filename) }}">{{ row.local_filename }}</a></td>
                    <td data-column="downloaded-at" data-sort="{{ row.downloaded_at or '' }}">{{ row.downloaded_at or '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No downloads recorded yet.</p>
    {% endif %}
</section>

<section class="card">
    <h3>Live Logs</h3>
    <pre id="log-output" class="log-area">{% for line in log_lines %}{{ line }}
{% endfor %}</pre>
</section>

<script>
const logOutput = document.getElementById('log-output');
if (window.EventSource) {
    const source = new EventSource('{{ url_for('logs_stream') }}');
    source.onmessage = function(event) {
        logOutput.textContent += event.data + "\n";
        logOutput.scrollTop = logOutput.scrollHeight;
    };
}

const table = document.getElementById('downloads-table');
if (table) {
    const tbody = table.querySelector('tbody');
    const courtSelect = document.getElementById('filter-court');
    const categorySelect = document.getElementById('filter-category');
    const searchInput = document.getElementById('filter-search');
    const headers = table.querySelectorAll('th[data-sort-key]');
    let currentSortKey = null;
    let sortDirection = 1;

    function applyFilters() {
        const court = courtSelect.value;
        const category = categorySelect.value;
        const term = searchInput.value.trim().toLowerCase();

        tbody.querySelectorAll('tr').forEach((row) => {
            const matchesCourt = !court || row.dataset.court === court;
            const matchesCategory = !category || row.dataset.category === category;
            const matchesSearch = !term || (row.dataset.search || '').includes(term);
            row.style.display = matchesCourt && matchesCategory && matchesSearch ? '' : 'none';
        });
    }

    function getSortValue(row, key) {
        const cell = row.querySelector(`[data-column="${key}"]`);
        if (!cell) {
            return '';
        }
        return (cell.getAttribute('data-sort') || cell.textContent || '').toLowerCase();
    }

    function sortRows(key) {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aVal = getSortValue(a, key);
            const bVal = getSortValue(b, key);
            if (aVal === bVal) {
                return 0;
            }
            return aVal > bVal ? sortDirection : -sortDirection;
        });
        rows.forEach((row) => tbody.appendChild(row));
    }

    headers.forEach((header) => {
        header.addEventListener('click', () => {
            const key = header.dataset.sortKey;
            if (currentSortKey === key) {
                sortDirection = -sortDirection;
            } else {
                currentSortKey = key;
                sortDirection = 1;
            }

            headers.forEach((h) => h.classList.remove('sorted-asc', 'sorted-desc'));
            header.classList.add(sortDirection === 1 ? 'sorted-asc' : 'sorted-desc');

            sortRows(key);
        });
    });

    courtSelect.addEventListener('change', applyFilters);
    categorySelect.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);
}
</script>
{% endblock %}
